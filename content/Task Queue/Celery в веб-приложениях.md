Celery ัะฒะปัะตััั ะฝะตะทะฐะผะตะฝะธะผัะผ ะธะฝััััะผะตะฝัะพะผ ะดะปั ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธะน, ะฒ ะบะพัะพััั ััะตะฑัะตััั ะพะฑัะฐะฑะฐััะฒะฐัั ะฑะพะปััะพะต ะบะพะปะธัะตััะฒะพ ะฟัะพะดะพะปะถะธัะตะปัะฝัั ะทะฐะดะฐั. ะ ะดะฐะฝะฝะพะผ ะผะฐัะตัะธะฐะปะต ะผั ัะฐััะผะพััะธะผ, ะบะฐะบ Celery ะธัะฟะพะปัะทัะตััั ะฒะผะตััะต ั Flask.

ะัะตะดะฟะพะปะพะถะธะผ, ััะพ ะตััั ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธะต, ะบะพัะพัะพะต ะฟะพะทะฒะพะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปัะผ ะทะฐะณััะถะฐัั ะธะทะพะฑัะฐะถะตะฝะธั ะดะปั ะพะฑัะฐะฑะพัะบะธ. ะั ัะพัะธะผ ะฟัะตะดะพััะฐะฒะธัั ะธะผ ะพะฟัะธะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพะน ะทะฐะณััะทะบะธ ะธ ะพะฑัะฐะฑะพัะบะธ ะฝะตัะบะพะปัะบะธั ะธะทะพะฑัะฐะถะตะฝะธะน ั ะฒะพะทะผะพะถะฝะพัััั ะพััะปะตะถะธะฒะฐะฝะธั ััะฐัััะฐ ะพะฑัะฐะฑะพัะบะธ ะบะฐะถะดะพะณะพ ะธะทะพะฑัะฐะถะตะฝะธั.

```python
import random  
  
from flask import Flask, request, jsonify  
from celery import Celery, group  
import time  
  
app = Flask(__name__)  
  
# ะะพะฝัะธะณััะฐัะธั Celery  
celery = Celery(  
ย ยapp.name,  
ย ยbroker='redis://localhost:6379/0',  
ย ยbackend='redis://localhost:6379/0',  
)  
  
# ะะฐะดะฐัะฐ Celery ะดะปั ะพะฑัะฐะฑะพัะบะธ ะธะทะพะฑัะฐะถะตะฝะธั  
@celery.task  
def process_image(image_id: str):  
ย ย# ะ ัะตะฐะปัะฝะพะน ัะธััะฐัะธะธ ะทะดะตัั ะผะพะถะตั ะฑััั ะพะฑัะฐะฑะพัะบะฐ ะธะทะพะฑัะฐะถะตะฝะธั  
ย ย# ะ ะดะฐะฝะฝะพะผ ะฟัะธะผะตัะต ะฟัะพััะพ ะดะตะปะฐะตะผ ะทะฐะดะตัะถะบั ะดะปั ะดะตะผะพะฝัััะฐัะธะธ  
ย ยtime.sleep(random.randint(5, 15))  
ย ยreturn f'Image {image_id} processed'  
  
@app.route('/process_images', methods=['POST'])  
def process_images():  
ย ยimages = request.json.get('images')  
  
ย ยif images and isinstance(images, list):  
ย ย ย ย# ะกะพะทะดะฐัะผ ะณััะฟะฟั ะทะฐะดะฐั  
ย ย ย ยtask_group = group(  
ย ย ย ย ย ยprocess_image.s(image_id)  
ย ย ย ย ย ยfor image_id in images  
ย ย ย ย)  
  
ย ย ย ย# ะะฐะฟััะบะฐะตะผ ะณััะฟะฟั ะทะฐะดะฐั ะธ ัะพััะฐะฝัะตะผ ะตั  
ย ย ย ยresult = task_group.apply_async()  
ย ย ย ยresult.save()  
  
ย ย ย ย# ะะพะทะฒัะฐัะฐะตะผ ะฟะพะปัะทะพะฒะฐัะตะปั ID ะณััะฟะฟั ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั  
ย ย ย ยreturn jsonify({'group_id': result.id}), 202  
ย ยelse:  
ย ย ย ยreturn jsonify({'error': 'Missing or invalid images parameter'}), 400  
  
@app.route('/status/<group_id>', methods=['GET'])  
def get_group_status(group_id: str):  
ย ยresult = celery.GroupResult.restore(group_id)  
  
ย ยif result:  
ย ย ย ย# ะัะปะธ ะณััะฟะฟะฐ ั ัะฐะบะธะผ ID ัััะตััะฒัะตั,  
ย ย ย ย# ะฒะพะทะฒัะฐัะฐะตะผ ะดะพะปั ะฒัะฟะพะปะฝะตะฝะฝัั ะทะฐะดะฐั  
ย ย ย ยstatus = result.completed_count() / len(result)  
ย ย ย ยreturn jsonify({'status': status}), 200  
ย ยelse:  
ย ย ย ย# ะะฝะฐัะต ะฒะพะทะฒัะฐัะฐะตะผ ะพัะธะฑะบั  
ย ย ย ยreturn jsonify({'error': 'Invalid group_id'}), 404  
  
if __name__ == '__main__':  
ย ยapp.run(debug=True)
```

ะะฐะฟัััะธัะต Redis (ะฒ ะบะฐัะตััะฒะต ะฑัะพะบะตัะฐ Celery):

```bash
docker run -p 6379:6379 --name my-redis -d redis
```

ะะฐะฟัััะธัะต ะฒะพัะบะตัั Celery ะดะปั ะพะฑัะฐะฑะพัะบะธ ะทะฐะดะฐั:

```bash
celery -A app.celery worker --loglevel=info
```

ะะฐะฟัััะธัะต Flask-ะฟัะธะปะพะถะตะฝะธะต:

```bash
python app.py
```

ะขะตะฟะตัั ะฒั ะผะพะถะตัะต ะพัะฟัะฐะฒะปััั POST-ะทะฐะฟัะพัั ะฝะฐ `/process_images` ะฒ ะฒะฐัะตะผ Flask-ะฟัะธะปะพะถะตะฝะธะธ, ะฟะตัะตะดะฐะฒะฐั ัะฟะธัะพะบ images ะฒ JSON-ัะพัะผะฐัะต. ะัะธะปะพะถะตะฝะธะต ัะพะทะดะฐัั ะณััะฟะฟั ะทะฐะดะฐั ะดะปั ะพะฑัะฐะฑะพัะบะธ ะบะฐะถะดะพะณะพ ะธะทะพะฑัะฐะถะตะฝะธั ะฒ ัะฟะธัะบะต ะธ ะฒะตัะฝัั `group_id`, ะบะพัะพััะน ะฟะพะทะฒะพะปะธั ะพััะปะตะถะธะฒะฐัั ััะฐััั ะพะฑัะฐะฑะพัะบะธ ะณััะฟะฟั ะทะฐะดะฐั. ะั ัะฐะบะถะต ะผะพะถะตัะต ะฟะพะปััะธัั ัะตะบััะธะน ััะฐััั ะณััะฟะฟั ะทะฐะดะฐั, ะพัะฟัะฐะฒะธะฒ GET-ะทะฐะฟัะพั ะฝะฐ `/status/<group_id>`.

ะัะปะธ ะบะฐะบะพะต-ะปะธะฑะพ ะธะทะพะฑัะฐะถะตะฝะธะต ะฝะต ััะฟะตะปะพ ะพะฑัะฐะฑะพัะฐัััั, ะฒั ัะฒะธะดะธัะต ะดััะณะพะต ะทะฝะฐัะตะฝะธะต, ะฝะฐะฟัะธะผะตั 0.66667.

ะะฝะพะณะธะต ัะฐะนัั ะธัะฟะพะปัะทััั ะธะผะตะฝะฝะพ ัะฐะบัั ะผะพะดะตะปั ะฒะทะฐะธะผะพะดะตะนััะฒะธั โ ัะฐะท ะฒ ัะตะบัะฝะดั ะพะฝะธ ะดะตะปะฐัั ะทะฐะฟัะพั ะบ ัะตัะฒะตัั, ะบะฐะบ ะฑัะดัะพ ัะฟัะฐัะธะฒะฐัั: ยซะั ะบะฐะบ ัะฐะผ?ยป โ ะฟะพะปััะฐัั ะพัะฒะตั ะธ ะพัะพะฑัะฐะถะฐัั ะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั.

ะญัะพั ะฟัะธะผะตั ะดะตะผะพะฝัััะธััะตั, ะบะฐะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ะณััะฟะฟะธัะพะฒะบะธ ะทะฐะดะฐั ะธ ะพััะปะตะถะธะฒะฐะฝะธะต ะธั ััะฐัััะฐ ั ะฟะพะผะพััั Celery ะฟะพะทะฒะพะปััั ะฟะฐัะฐะปะปะตะปัะฝะพ ะพะฑัะฐะฑะฐััะฒะฐัั ะผะฝะพะถะตััะฒะพ ะทะฐะดะฐั ะธ ะบะพะฝััะพะปะธัะพะฒะฐัั ะธั ะฒัะฟะพะปะฝะตะฝะธะต, ัะปัััะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะธ ัะฟัะฐะฒะปัะตะผะพััั ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธั.

----
## ะัะฐะบัะธะบะฐ

ะะพัะฐะฑะพัะฐะนัะต ะฟัะธะปะพะถะตะฝะธะต, ะดะพะฑะฐะฒะธะฒ ัะปะตะดัััะธะต endpoints:

- `/cancel/<group_id>`  
    ะัะผะตะฝัะตั ะณััะฟะฟั ะทะฐะดะฐั. ะ ััะพะผ ะฒะฐะผ ะฟะพะผะพะถะตัย[ะผะตัะพะด revoke](https://docs.celeryq.dev/en/stable/userguide/workers.html#revoke-revoking-tasks).
- `/control`  
    ะัะพะฑัะฐะถะฐะตั ะธะฝัะพัะผะฐัะธั ะพ ะทะฐะดะฐัะฐั ะธ ะพัะตัะตะดัั ั ะฟะพะผะพัััย[ะผะตัะพะดะพะฒ celery.app.control](https://docs.celeryq.dev/en/latest/reference/celery.app.control.html). ะกะดะตะปะฐะนัะต ัะฐะบ, ััะพะฑั ะธะฝัะพัะผะฐัะธั ะฐะบััะฐะปะธะทะธัะพะฒะฐะปะฐัั ัะฐะท ะฒ 10 ัะตะบัะฝะด, ะฐ ะฝะต ะฟัะธ ะบะฐะถะดะพะผ ะทะฐะฟัะพัะต.

----
๐ [[Task Queue]]