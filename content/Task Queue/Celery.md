# ะะฝัััะตะฝะฝะตะต ััััะพะนััะฒะพ

Celery ัะพััะพะธั ะธะท ะฝะตัะบะพะปัะบะธั ะบะพะผะฟะพะฝะตะฝัะพะฒ, ะบะพัะพััะต ะฒะทะฐะธะผะพะดะตะนััะฒััั ะผะตะถะดั ัะพะฑะพะน ะดะปั ะพะฑัะฐะฑะพัะบะธ ะทะฐะดะฐั:

- **ะัะพะบะตั ัะพะพะฑัะตะฝะธะน**ยโ ััะพ ะผะตัะฐะฝะธะทะผ, ะบะพัะพััะน ะฟะพะทะฒะพะปัะตั ะฟะตัะตะดะฐะฒะฐัั ะทะฐะดะฐัะธ ะพั ะฟัะธะปะพะถะตะฝะธั ะบ ัะฐะฑะพัะธะผ ะฟัะพัะตััะฐะผ Celery. ะั ะผะพะถะตัะต ะฒัะฑัะฐัั ัะฐะทะปะธัะฝัะต ะฑัะพะบะตัั, ัะฐะบะธะต ะบะฐะบ RabbitMQ, Redis ะธะปะธ Amazon SQS, ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ะฒะฐัะธั ะฟะพััะตะฑะฝะพััะตะน.
- **ะะฐะฑะพัะธะต ะฟัะพัะตััั**ยโ ััะพ ะพัะดะตะปัะฝัะต ะฟัะพัะตััั, ะบะพัะพััะต ัะปััะฐัั ะฑัะพะบะตั ัะพะพะฑัะตะฝะธะน ะธ ะฒัะฟะพะปะฝััั ะฟะพัััะฟะฐััะธะต ะฒ ะพัะตัะตะดั ะทะฐะดะฐัะธ. ะั ะผะพะถะตัะต ะทะฐะฟััะบะฐัั ะฝะตัะบะพะปัะบะพ ัะฐะฑะพัะธั ะฟัะพัะตััะพะฒ, ััะพะฑั ัะฐัะฟัะตะดะตะปะธัั ะฝะฐะณััะทะบั ะธ ะพะฑะตัะฟะตัะธัั ะฟะฐัะฐะปะปะตะปัะฝะพะต ะฒัะฟะพะปะฝะตะฝะธะต ะทะฐะดะฐั.
- **ะะฐะดะฐัะธ**ยโ ััะพ ััะฝะบัะธะธ, ะบะพัะพััะต ะฒั ะพะฟัะตะดะตะปัะตัะต ะฒ ะฒะฐัะตะผ ัะฐะนะปะต tasks.py. ะะฝะธ ะผะพะณัั ะฑััั ะฒัะฟะพะปะฝะตะฝั ะฐัะธะฝััะพะฝะฝะพ ัะฐะฑะพัะธะผะธ ะฟัะพัะตััะฐะผะธ.
- **ะะตะทัะปััะฐัั**. Celery ะฟะพะทะฒะพะปัะตั ะฟะพะปััะฐัั ัะตะทัะปััะฐัั ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะดะฐั. ะั ะผะพะถะตัะต ะฒัะฑัะฐัั ัะฐะทะปะธัะฝัะต ะฑัะบะตะฝะดั ะดะปั ััะฐะฝะตะฝะธั ัะตะทัะปััะฐัะพะฒ, ัะฐะบะธะต ะบะฐะบ Redis, ะฑะฐะทะฐ ะดะฐะฝะฝัั ะธะปะธ ัะฐะนะปะพะฒะฐั ัะธััะตะผะฐ.

Celery ะธัะฟะพะปัะทัะตั ะผะตัะฐะฝะธะทะผั ัะตัะธะฐะปะธะทะฐัะธะธ ะดะฐะฝะฝัั ะดะปั ะฟะตัะตะดะฐัะธ ะทะฐะดะฐั ะธ ัะตะทัะปััะฐัะพะฒ ะผะตะถะดั ะบะพะผะฟะพะฝะตะฝัะฐะผะธ.

----
### ะฃััะฐะฝะพะฒะบะฐ ะธ ะทะฐะฟััะบ

ะะปั ัะฐะฑะพัั ั Celery ะฟะพะฝะฐะดะพะฑะธััั ัััะฐะฝะพะฒะธัั ะฑัะพะบะตั ัะพะพะฑัะตะฝะธะน.ย**ะัะพะบะตั ัะพะพะฑัะตะฝะธะน**ยโ ััะพ ัะฟะตัะธะฐะปัะฝะฐั ัะปัะถะฑะฐ, ะบ ะบะพัะพัะพะน ะฟะพะดะบะปััะฐัััั ะพัะฟัะฐะฒะธัะตะปะธ ะธ ะฟะพะปััะฐัะตะปะธ ะดะฐะฝะฝัั. ะ ัะพะปะธ ะฑัะพะบะตัะฐ ะผะพะณัั ะฒััััะฟะฐัั Redis, RabbitMQ ะธ Amazon SQS. ะ ะบะฐัะตััะฒะต ะฟัะธะผะตัะฐ ะฒะพะทัะผัะผ Redis, ัะฐะบ ะบะฐะบ ะพะฝ ัะฒะปัะตััั ะฟัะพัััะผ ะธ ะฝะฐะธะฑะพะปะตะต ะธัะฟะพะปัะทัะตะผัะผ.

**Redis**ยโ ะพะดะฝะพ ะธะท ัะฐะผัั ะฟะพะฟัะปััะฝัั ััะฐะฝะธะปะธั ะดะฐะฝะฝัั ะฒ ะฟะฐะผััะธ, ะบะพัะพัะพะต ะธัะฟะพะปัะทัะตััั ะดะปั ัะฐะทะปะธัะฝัั ะทะฐะดะฐั, ะฒะบะปััะฐั:ย

- ะบะตัะธัะพะฒะฐะฝะธะต,ย
- ัะตััะธะพะฝะฝะพะต ััะฐะฝะธะปะธัะต,ย
- ะพัะตัะตะดะธ ะทะฐะดะฐะฝะธะน ะธ ะผะฝะพะณะพะต ะดััะณะพะต.

ะะฐะฒะฐะนัะต ัััะฐะฝะพะฒะธะผ ะธ ะทะฐะฟัััะธะผ Redis ั ะฟะพะผะพััั Docker.

- ะงัะพะฑั ะทะฐะฟัััะธัั ะบะพะฝัะตะนะฝะตั Redis, ะฒัะฟะพะปะฝะธัะต ะบะพะผะฐะฝะดั:

```bash
docker run -p 6379:6379 --name my-redis -d redis
```

ะะปั ัััะฐะฝะพะฒะบะธ Celery ะฒัะฟะพะปะฝะธัะต ะบะพะผะฐะฝะดั ัะตัะตะท pip:

```
pip install celery[redis]==5.3.1
```

ะะพัะปะต ัััะฐะฝะพะฒะบะธ Celery ะฒั ะผะพะถะตัะต ัะพะทะดะฐัั ัะฐะนะป `tasks.py`, ะฒ ะบะพัะพัะพะผ ะฑัะดะตั ัะพะดะตัะถะฐัััั ะบะพะด ะดะปั ะฒะฐัะธั ะทะฐะดะฐั.

ะัะธะผะตั ะฟัะพััะพะน ะทะฐะดะฐัะธ ะฒ ัะฐะนะปะต `tasks.py`:

```python
from celery import Celery  
app = Celery(  
ย ย'tasks',  
ย ยbroker='redis://localhost:6379/0',  
ย ยbackend='redis://localhost:6379/0'  
)  
@app.task  
def add(x, y):  
ย ยreturn x + y
```

- tasks โ ะฝะฐะทะฒะฐะฝะธะต ะฝะฐัะตะณะพ Celery-ะฟัะธะปะพะถะตะฝะธั.ย
- broker โ URL ะฑัะพะบะตัะฐ ัะพะพะฑัะตะฝะธะน.ย
- backend โ URL ััะฐะฝะธะปะธัะฐ ัะตะทัะปััะฐัะพะฒ; ะผะพะถะฝะพ ัะบะฐะทะฐัั URL ะฑัะพะบะตัะฐ.ย

ะะฐะฝะฝัะน ะบะพะด ะฒั ะผะพะถะตัะต ะฝะฐะนัะธ ะฒ ัะตะฟะพะทะธัะพัะธะธ ั ะฟัะฐะบัะธัะตัะบะพะน ัะฐะฑะพัะพะน.

ะะปั ะทะฐะฟััะบะฐ ัะฐะฑะพัะธั ะฟัะพัะตััะพะฒ Celery, ะบะพัะพััะต ะฑัะดัั ะพะฑัะฐะฑะฐััะฒะฐัั ะทะฐะดะฐัะธ, ะฒัะฟะพะปะฝะธัะต ะบะพะผะฐะฝะดั:

```bash
celery -A tasks worker
```

ะขะตะฟะตัั ะพัะตัะตะดั ะทะฐะดะฐั ะณะพัะพะฒะฐ ะบ ัะฐะฑะพัะต. ะั ะผะพะถะตัะต ะดะพะฑะฐะฒะปััั ะทะฐะดะฐัะธ ะธ ะฒัะฟะพะปะฝััั ะธั:

```python
>>> from tasks import add  
>>> result = add.delay(4, 5)  
>>> result  
<AsyncResult: 6c6de6cb-4e95-4815-b02a-0d5d048b6e80>  
>>> result.get()  
9
```

----
## ะะฑะทะพั ะฒะพะทะผะพะถะฝะพััะตะน

Celery ะดะฐัั ะผะฝะพะณะพ ะฒะพะทะผะพะถะฝะพััะตะน ะดะปั ัััะตะบัะธะฒะฝะพะน ัะฐะฑะพัั ั ะพัะตัะตะดัะผะธ ะทะฐะดะฐั. ะะฐะธะฑะพะปะตะต ะฟะพะฟัะปััะฝัะต ะธะท ะฝะธั, ั ะบะพัะพััะผะธ ะฒั ััะพะปะบะฝััะตัั ะฝะฐ ะฟัะฐะบัะธะบะต:

- ะะปะฐะฝะธัะพะฒะฐะฝะธะต ะทะฐะดะฐั.
- ะััะฟะฟั ะธ ัะตะฟะพัะบะธ ะทะฐะดะฐั.
- ะััะปะตะถะธะฒะฐะฝะธะต ัะพััะพัะฝะธั ะทะฐะดะฐั.

ะััะฐะฝะพะฒะธะผัั ะฝะฐ ะฝะธั ะฟะพะดัะพะฑะฝะตะต.

### ะะปะฐะฝะธัะพะฒะฐะฝะธะต ะทะฐะดะฐั

ะะปะฐะฝะธัะพะฒะฐะฝะธะต ะทะฐะดะฐั ะฒ Celery ะฟะพะทะฒะพะปัะตั ะทะฐะฟััะบะฐัั ะทะฐะดะฐัะธ ะฒ ะพะฟัะตะดะตะปัะฝะฝะพะต ะฒัะตะผั ะธะปะธ ัะตัะตะท ะพะฟัะตะดะตะปัะฝะฝัะต ะธะฝัะตัะฒะฐะปั.ย

ะะปั ััะพะณะพ ะธัะฟะพะปัะทัะตัััย**Celery Beat**ยโ ัะฟะตัะธะฐะปัะฝัะน ะธะฝััััะผะตะฝั ะดะปั ะฟะปะฐะฝะธัะพะฒะฐะฝะธั ะธ ัะฟัะฐะฒะปะตะฝะธั ะฟะตัะธะพะดะธัะตัะบะธะผะธ ะทะฐะดะฐัะฐะผะธ. Celery Beat ะฟะพะทะฒะพะปัะตั ะทะฐะดะฐัั ัะฐัะฟะธัะฐะฝะธะต ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะดะฐั.

ะัะธะผะตั ะฟะตัะธะพะดะธัะตัะบะพะน ะทะฐะดะฐัะธ:

```python
from random import random  
  
from celery import Celery  
from celery.schedules import crontab  
  
app = Celery(  
ย ย'tasks',  
ย ยbroker='redis://localhost:6379/0',  
ย ยbackend='redis://localhost:6379/0'  
)  
  
@app.on_after_configure.connect  
def setup_periodic_tasks(sender, **kwargs):  
ย ยsender.add_periodic_task(60, check_cat.s())  
ย ยsender.add_periodic_task(  
ย ย ย ยcrontab(hour=7, minute=30, day_of_week=1),  
ย ย ย ยcheck_cat.s()  
ย ย)  
  
@app.task  
def check_cat():  
ย ยif random() < 0.5:  
ย ย ย ยprint("ะะพั ะฝะธัะตะณะพ ะฝะต ัะปะพะผะฐะป.")  
ย ยelse:  
ย ย ย ยprint("ะะพั ััะพ-ัะพ ัะปะพะผะฐะป...")
```

ะ ะดะฐะฝะฝะพะผ ะฟัะธะผะตัะต ะฒั ะพะฟัะตะดะตะปัะตัะต ะฟะตัะธะพะดะธัะตัะบัั ะทะฐะดะฐัั `check_cat`, ะบะพัะพัะฐั ะฑัะดะตั ะฒัะฟะพะปะฝััััั ะบะฐะถะดัั ะผะธะฝััั ะธ ะฟัะพะฒะตัััั, ัะปะพะผะฐะป ะปะธ ะบะพั ััะพ-ะปะธะฑะพ.ย

ะก ะฟะพะผะพััั crontab ะทะฐะฟะปะฐะฝะธัะพะฒะฐะปะธ ัั ะถะต ะทะฐะดะฐัั `check_cat`, ะบะพัะพัะฐั ะฑัะดะตั ะฒัะฟะพะปะฝััััั ะบะฐะถะดัะน ะฟะพะฝะตะดะตะปัะฝะธะบ ะฒ 07:30.

ะะปั ะทะฐะฟััะบะฐ ัะตัะฒะธัะฐ Celery Beat ะทะฐะฟัััะธัะต ะบะพะผะฐะฝะดั:

```bash
celery -A tasks beat
```

ะขะฐะบะถะต ะผะพะถะฝะพ ะทะฐะฟัััะธัั beat ะฒะฝัััะธ ัะฐะฑะพัะตะณะพ ะฟัะพัะตััะฐ:

```bash
celery -A tasks worker -B
```

ะะพ ะดะตะปะฐัั ััะพ ะฝะต ัะตะบะพะผะตะฝะดัะตััั, ะธััะพะดั ะธะท ะฟัะธะฝัะธะฟะฐ ะตะดะธะฝะพะน ะพัะฒะตัััะฒะตะฝะฝะพััะธ. ะัะธ ะธะทะผะตะฝะตะฝะธะธ worker ะทะฐััะฐะณะธะฒะฐะตััั ะธ Celery Beat. ะัะปะธ ััะพ-ัะพ ะธะท ััะพะณะพ ัะฟะฐะดัั, ัะพ ัะฟะฐะดัั ะฒัั ััะฐะทั.

### ะััะฟะฟั ะธ ัะตะฟะพัะบะธ ะทะฐะดะฐั

ะะฝะธ ะฟะพะทะฒะพะปััั ะพะฑัะตะดะธะฝััั ะฝะตัะบะพะปัะบะพ ะทะฐะดะฐั ะธ ัะฟัะฐะฒะปััั ะธั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝัะผ ะธะปะธ ะฟะฐัะฐะปะปะตะปัะฝัะผ ะฒัะฟะพะปะฝะตะฝะธะตะผ.

#### ะััะฟะฟั ะทะฐะดะฐั

**ะััะฟะฟั ะทะฐะดะฐั**ยโ ััะพ ะผะตัะฐะฝะธะทะผ ะดะปั ะฟะฐัะฐะปะปะตะปัะฝะพะณะพ ะทะฐะฟััะบะฐ ะณััะฟะฟั ะทะฐะดะฐั ะธ ะฟะพะปััะตะฝะธั ัะตะทัะปััะฐัะพะฒ ะพัะดะตะปัะฝะพ ะดะปั ะบะฐะถะดะพะน ะธะท ะฝะธั.

ะะธะถะต ะฟัะธะฒะตะดัะฝ ะฟัะธะผะตั, ะฒ ะบะพัะพัะพะผ ะผั ะฟะพะบัะฟะฐะตะผ ะผะพะปะพะบะพ ะธ ัะปะตะฑ. ะญัะธ ะทะฐะดะฐัะธ ะณััะฟะฟะธัััััั ะดะปั ะฟะฐัะฐะปะปะตะปัะฝะพะณะพ ะฒัะฟะพะปะฝะตะฝะธั.

```python
@app.task  
def buy_milk(volume: int) -> int:  
ย ยprint(f'ะะพะบัะฟะฐะตะผ {volume} ะปะธััะพะฒ ะผะพะปะพะบะฐ')  
ย ยreturn volume  
  
@app.task  
def buy_bread(count: int) -> int:  
ย ยprint(f'ะะพะบัะฟะฐะตะผ {count} ะฑััะฐะฝะพะบ ัะปะตะฑะฐ')  
ย ยreturn count  
  
from celery import group  
from tasks import buy_milk, buy_bread  
  
task1 = buy_milk.s(7)  
task2 = buy_bread.s(5)  
  
task_group = group(task1, task2)  
result = task_group.apply_async()  
  
results = result.get()  
print(results) ย# [7, 5]
```

#### ะฆะตะฟะพัะบะธ ะทะฐะดะฐั

**ะฆะตะฟะพัะบะธ ะทะฐะดะฐั**ยโ ััะพ ะผะตัะฐะฝะธะทะผ ะดะปั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพะณะพ ะทะฐะฟััะบะฐ ะทะฐะดะฐั, ะณะดะต ัะตะทัะปััะฐั ะพะดะฝะพะน ะทะฐะดะฐัะธ ะฟะตัะตะดะฐัััั ะฒ ะบะฐัะตััะฒะต ะฐัะณัะผะตะฝัะฐ ัะปะตะดัััะตะน.

ะ ะฟัะธะผะตัะต ะฝะธะถะต โ ัะตะทัะปััะฐั ะทะฐะดะฐัะธ `fetch_user_name` ะฟะตัะตะดะฐัััั ะฝะฐ ะฒัะพะด ะทะฐะดะฐัะต `greeting_user`.

```python
@app.task  
def fetch_user_name(id: int) -> str:  
ย ยreturn f'ะััั {id}ะะตัะฒัะน'  
  
@app.task  
def greeting_user(name: str) -> str:  
ย ยreturn f'ะะดัะฐะฒััะฒัะน, {name}!'  
  
from celery import chain  
from tasks import fetch_user_name, greeting_user  
  
task1 = fetch_user_name.s(1)  
task2 = greeting_user.s()  
  
task_chain = chain(task1 | task2)  
result = task_chain.apply_async()  
  
final_result = result.get()  
print(final_result) ย# ะะดัะฐะฒััะฒัะน, ะััั ะะตัะฒัะน!
```

### ะััะปะตะถะธะฒะฐะฝะธะต ัะพััะพัะฝะธั ะทะฐะดะฐั

Celery ะฟะพะทะฒะพะปัะตั ะพััะปะตะถะธะฒะฐัั ััะฐััั ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะดะฐั. ะัะธ ะทะฐะฟััะบะต ะฐัะธะฝััะพะฝะฝะพะน ะทะฐะดะฐัะธ ั ะฟะพะผะพััั `apply_async()` ะฒั ะฟะพะปััะฐะตัะต ะพะฑัะตะบั `AsyncResult`, ะบะพัะพััะน ะฟะพะทะฒะพะปัะตั ะพััะปะตะดะธัั ัะพััะพัะฝะธะต ะทะฐะดะฐัะธ ะธ ะฟะพะปััะธัั ะตั ัะตะทัะปััะฐัั ะฟะพ ะทะฐะฒะตััะตะฝะธะธ.

ะ ะฟัะธะผะตัะต ะฝะธะถะต ะผั ะฟะพะปััะธะผ ะพัะธะฑะบั, ะตัะปะธ ะฝะฐ ะฒัะพะด ะดะฐะดะธะผ ัััะพะบั. ะขะฐะบัั ะพัะธะฑะบั ะผะพะถะฝะพ ะฝะฐะนัะธ ั ะฟะพะผะพััั ะฟัะพะฒะตัะบะธ `result.successful()` ะธ ะฐััะธะฑััะฐ `result`.

```python
@app.task  
def heavy_task(n: int) -> int:  
ย ยresult = 1  
ย ยfor i in range(2, n):  
ย ย ย ยresult *= i  
ย ย ย ยtime.sleep(0.01)  
ย ยreturn result  
  
from tasks import heavy_task  
  
def get_factorial(arg):  
ย ยresult = heavy_task.apply_async(args=(arg,))  
  
ย ยwhile not result.ready():  
ย ย ย ย# ะะฐะดะฐัะฐ ะตัั ะฒัะฟะพะปะฝัะตััั  
ย ย ย ยpass  
  
ย ยif result.successful():  
ย ย ย ยresult_value = result.get()  
ย ยelse:  
ย ย ย ย# ะะฝัะพัะผะฐัะธั ะพะฑ ะพัะธะฑะบะต  
ย ย ย ยresult_value = result.result  
  
ย ยprint(result_value)  
  
get_factorial(50) ย  
# 608281864034267560872252163321295376887552831379210240000000000  
get_factorial('ะกะตะนัะฐั ะฑัะดะตั ะพัะธะฑะบะฐ') ย  
# 'str' object cannot be interpreted as an integer
```

ะขะฐะบะธะผ ะพะฑัะฐะทะพะผ, ะผะพะถะฝะพ ะณะธะฑะบะพ ะผะฐะฝะธะฟัะปะธัะพะฒะฐัั ะทะฐะดะฐัะฐะผะธ, ะฟะพะฒััะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ั ะฟะพะผะพััั ะณััะฟะฟะธัะพะฒะบะธ ะธ ะฒััััะฐะธะฒะฐะฝะธั ะทะฐะดะฐั ะฒ ัะตะฟะพัะบะธ, ะฐ ัะฐะบะถะต ะฟะพะฒััะฐั ะพัะบะฐะทะพัััะพะนัะธะฒะพััั ั ะฟะพะผะพััั ะพััะปะตะถะธะฒะฐะฝะธั ัะพััะพัะฝะธั ะทะฐะดะฐั.



----
๐ [[Task Queue]]