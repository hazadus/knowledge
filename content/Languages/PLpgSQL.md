## –û–±–∑–æ—Ä –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —è–∑—ã–∫–∞ PL/pgSQL

> [!info] DEV1-12. 11. –û–±–∑–æ—Ä –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —è–∑—ã–∫–∞ PL/pgSQL  
> DEV1-12.  
> [https://www.youtube.com/watch?v=CSvxdO8XgAk](https://www.youtube.com/watch?v=CSvxdO8XgAk)  

> [https://edu.postgrespro.ru/dev1-12/dev1_11_plpgsql_introduction.html](https://edu.postgrespro.ru/dev1-12/dev1_11_plpgsql_introduction.html)  

–Ø–∑—ã–∫ –ø–æ—è–≤–∏–ª—Å—è –≤ –≤–µ—Ä—Å–∏–∏ 6.4 –≤ 1998 –≥–æ–¥—É.

–¶–µ–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è:
- –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫ –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤;
- –¥–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫ —è–∑—ã–∫—É SQL;
- —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª—é–±—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–∏–ø–æ–≤, —Ñ—É–Ω–∫—Ü–∏–π –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤.
### –ë–∞–∑–æ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —è–∑—ã–∫–∞

–î–æ—Å—Ç—É–ø–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å SQL, –ø—Ä–æ—Å—Ç –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏.

![[Untitled 11.png]]

–û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –±–ª–æ–∫–µ `DECLARE`:

```plpgsql
foo text;
bar text := 'hello';
-- –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏–º–µ—é—Ç –æ—á–µ–≤–∏–¥–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ:
baz integer NOT NULL := 0;
spam CONSTANT text := "answer is 42";
```

–í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è:

```plpgsql
-- –í–º–µ—Å—Ç–æ % –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
RAISE NOTICE '%, %!', foo, bar;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–¥–ø—Ä–æ–≥—Ä–∞–º–º

PL/pgSQL –º–æ–∂–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö. –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–¥–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä (–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äì none):

```
SET plpgsql.extra_warnings = 'all';
```

–¢–∞–∫ –±—É–¥—É—Ç –≤—ã–≤–æ–¥–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ —Å–æ–≤–µ—Ç—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ –≤—ã–∑–æ–≤–µ –ø–æ–¥–ø—Ä–æ–≥—Ä–∞–º–º, –≥–¥–µ –µ—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –≤ –∫–æ–¥–µ.

### –û–±—ä—è–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π

–§—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –æ–±—ä—è–≤–ª—è—é—Ç—Å—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ –¥–ª—è –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤, –Ω–æ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —è–∑—ã–∫ ‚Äì `LANGUAGE plpgsql`. –í –∫–æ–Ω—Ü–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å "–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑–º–µ–Ω—á–∏–≤–æ—Å—Ç–∏" ‚Äì `IMMUTABLE` –≤ –ø—Ä–∏–º–µ—Ä–µ –Ω–∏–∂–µ.

–ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏, –≤–æ–∑–≤–æ–¥—è—â–µ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ –∫–≤–∞–¥—Ä–∞—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—â–µ–π –∑–Ω–∞—á–µ–Ω–∏–µ:

```plpgsql
CREATE FUNCTION sqr_in(IN a NUMERIC) RETURNS numeric
AS $$
BEGIN
	RETURN a * a;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

–¢–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è, –Ω–æ —Å OUT-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º. –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —ç—Ç–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É:

```plpgsql
CREATE FUNCTION sqr_out(IN a NUMERIC, OUT retval numeric)
AS $$
BEGIN
	retval := a * a;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

–¢–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏—è, –Ω–æ —Å INOUT-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º. –¢–∞–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è, –∏ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏:

```plpgsql
CREATE FUNCTION sqr_inout(INOUT a NUMERIC)
AS $$
BEGIN
	a := a * a;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ë–î –ø–æ –µ—ë –Ω–∞–∑–≤–∞–Ω–∏—é

–°–∞–º –Ω–∞–ø–∏—Å–∞–ª:

```
DO $$
DECLARE
	-- –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –º—ã —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∏—Ç—å:
	proc_name TEXT := 'fmt';
	proc_oid INT;
	proc_code TEXT;
BEGIN
	SELECT oid INTO proc_oid FROM pg_proc WHERE proname = proc_name;
	RAISE NOTICE '% oid=%', proc_name, proc_oid;

	-- –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –≤—ã–≤–æ–¥–∏–º –µ–≥–æ:
	SELECT pg_get_functiondef(proc_oid) INTO proc_code FROM pg_proc WHERE oid = proc_oid;
	RAISE NOTICE '%', proc_code;
END;
$$;
```

### –£—Å–ª–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã

#### `IF...THEN...ELSE...`

–û–±—â–∏–π –≤–∏–¥ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º `IF`:

```
IF —É—Å–ª–æ–≤–∏–µ THEN
	-- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
ELSIF —É—Å–ª–æ–≤–∏–µ THEN
	-- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
ELSE
	-- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
END IF;
```

–ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–π —É—Å–ª–æ–≤–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤–∞ –∑–Ω–∞—á–µ–Ω–∏—è - –∫–æ–¥ –∏ –Ω–æ–º–µ—Ä –æ—Ç–¥–µ–ª—å–Ω–æ:

```
CREATE FUNCTION fmt(IN phone text, OUT code text, OUT num text)
AS $$
BEGIN
	IF PHONE ~ '^[0-9]*$' AND length(phone) = 10 THEN
		code := substr(phone, 1, 3);
		num  := substr(phone, 4);
	ELSE
		code := NULL;
		num  := NULL;
	END IF;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

#### `CASE...WHEN...ELSE`

–û–±—â–∏–π –≤–∏–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ `CASE` (–ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äì –ø–æ —É—Å–ª–æ–≤–∏—é):

```
CASE
	WHEN —É—Å–ª–æ–≤–∏–µ THEN
		-- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
	ELSE
		-- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
END CASE;
```

- –°–µ–∫—Ü–∏—è `WHEN` –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.
- –°–µ–∫—Ü–∏—è `ELSE` –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–ª–æ–∫, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–µ—Ä–≤–æ–º—É –∏—Å—Ç–∏–Ω–Ω–æ–º—É —É—Å–ª–æ–≤–∏—é.
- –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –∏–∑ —É—Å–ª–æ–≤–∏–π –Ω–µ –∏—Å—Ç–∏–Ω–Ω–æ, –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –±–ª–æ–∫ `ELSE` (–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É).

```
DO $$
DECLARE
	code text := (fmt('8123556656')).code;
BEGIN
	CASE
		WHEN code IN ('495', '499') THEN
			RAISE NOTICE '% - Moscow', code;
		WHEN code = '812' THEN
			RAISE NOTICE '% - Saint-Petersburg', code;
		ELSE
			RAISE NOTICE '% - Misc', code;
	END CASE;
END;
$$;
```

–û–±—â–∏–π –≤–∏–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ `CASE` (–≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äì –ø–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—é):

```
CASE –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
	WHEN –∑–Ω–∞—á–µ–Ω–∏–µ, ... THEN
		-- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
	ELSE
		-- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
END CASE
```

- –°–µ–∫—Ü–∏—è `WHEN` –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.
- –°–µ–∫—Ü–∏—è `ELSE` –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–ª–æ–∫, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–µ—Ä–≤–æ–º—É –∏—Å—Ç–∏–Ω–Ω–æ–º—É —É—Å–ª–æ–≤–∏—é "–≤—ã—Ä–∞–∂–µ–Ω–∏–µ = –∑–Ω–∞—á–µ–Ω–∏–µ".
- –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –∏–∑ —É—Å–ª–æ–≤–∏–π –Ω–µ –∏—Å—Ç–∏–Ω–Ω–æ, –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –±–ª–æ–∫ `ELSE` (–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤ —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É).

```
DO $$
DECLARE
	code text := (fmt('8123556656')).code;
BEGIN
	CASE code
		WHEN '495', '499' THEN
			RAISE NOTICE '% - Moscow', code;
		WHEN '812' THEN
			RAISE NOTICE '% - Saint-Petersburg', code;
		ELSE
			RAISE NOTICE '% - Misc', code;
	END CASE;
END;
$$;
```

### –¶–∏–∫–ª—ã

–í—Å–µ —Ü–∏–∫–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±—â—É—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é:

```
LOOP
	-- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
END LOOP;
```

#### `FOR`

–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–≤–µ–Ω 1, low –∏ high –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ü–∏–∫–ª–∞ (—Ç–æ –µ—Å—Ç—å 0 .. 10 –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è 11 —Ä–∞–∑):

```
FOR name IN low .. high BY increment
LOOP
	-- operators;
END LOOP;

-- –∏—Ç–µ—Ä–∞—Ü–∏–∏ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ:
FOR name IN REVERSE high .. low BY increment
LOOP
	-- operators;
END LOOP;
```

```
DO $$
BEGIN
	FOR i IN 0 .. 10
	LOOP
		RAISE NOTICE '%', i;
	END LOOP;
END;
$$;
```

–ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫—É:

```
CREATE FUNCTION reverse_for (line TEXT) returns TEXT
AS $$
DECLARE
	line_len CONSTANT int := length(line);
	retval text := '';
BEGIN
	FOR i IN 1 .. line_len
	LOOP
		-- || - —ç—Ç–æ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Å—Ç—Ä–æ–∫:
		retval := substr(line, i, 1) || retval;
	END LOOP;
	RETURN retval;
END;
$$ LANGUAGE plpgsql IMMUTABLE STRICT;
```
`STRICT` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω –≤—Ö–æ–¥–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–µ—Ä–Ω–µ—Ç—Å—è `NULL` –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ–ª–∞ —Ñ—É–Ω–∫—Ü–∏–∏.

#### `LOOP`

–¶–∏–∫–ª `LOOP` –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ. –î–ª—è –≤—ã—Ö–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä `EXIT`: `EXIT label WHEN condition;`.
–ú–µ—Ç–∫–∞ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞. `WHEN` —Ç–æ–∂–µ ‚Äì –ø—Ä–∏ –µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ü–∏–∫–ª –ø—Ä–µ—Ä–≤–µ—Ç—Å—è –±–µ–∑—É—Å–ª–æ–≤–Ω–æ.

–í–∞—Ä–∏–∞–Ω—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `LOOP`:

```
CREATE FUNCTION reverse_loop (line TEXT) RETURNS text
AS $$
DECLARE
	line_len CONSTANT INT := length(line);
	i INT := 1;
	retval TEXT := '';
BEGIN
	<<main_loop>>
	LOOP
		EXIT main_loop WHEN i > line_len;
		retval := substr(line, i, 1) || retval;
		i := i + 1;
	END LOOP;
	RETURN retval;
END;
$$ LANGUAGE plpgsql IMMUTABLE STRICT;
```

–û–ø–µ—Ä–∞—Ç–æ—Ä `CONTINUE` –Ω–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é —Ü–∏–∫–ª–∞, –º–æ–∂–µ—Ç –±—ã—Ç—å —Å —É—Å–ª–æ–≤–∏–µ–º –∏ –±–µ–∑ —É—Å–ª–æ–≤–∏—è:

```
DO $$
DECLARE
	s INTEGER := 0;
BEGIN
	FOR i IN 1 .. 100
	LOOP
		s := s + i;
		CONTINUE WHEN mod(i, 10) != 0;
		-- –ü–µ—á–∞—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ 10 i:
		RAISE NOTICE 'i = %, s = %', i, s;
	END LOOP;
END;
$$;
```

## –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–π

–°–∞–º –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä `pl/pgSQL` –Ω–µ —É–º–µ–µ—Ç –≤—ã—á–∏—Å–ª—è—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –æ–Ω–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ SQL. –¢–æ –µ—Å—Ç—å, –≤—Å—Ç—Ä–µ—á–∞—è –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –¥–µ–ª–∞–µ—Ç—Å—è `SELECT`+`–≤—ã—Ä–∞–∂–µ–Ω–∏–µ` –∏ –±–µ—Ä–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ SQL, –≤–∫–ª—é—á–∞—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã;
- –Ω–µ–≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —Ö–æ—Ç—è —Ä–∞–∑–æ–±—Ä–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫—ç—à–∏—Ä—É–µ—Ç—Å—è;
- –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏ –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ –∏–º—ë–Ω.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞:

```
DO $$
BEGIN
	RAISE NOTICE '%', (
		SELECT name
		FROM users
		WHERE id = 1
	);
END;
$$;
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö
 
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–¥–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `test` –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–µ `1`:

```
CREATE TABLE test(n INTEGER);

CREATE PROCEDURE foo()
AS $$
BEGIN
	INSERT INTO test VALUES(1);
	COMMIT;
	INSERT INTO test VALUES(2);
	ROLLBACK;
END;
$$ LANGUAGE plpgsql;

CALL foo();
```

–ï—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ —Å–∞–º–∞ –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —É–∂–µ –Ω–∞—á–∞—Ç–æ–π —Ä–∞–Ω–µ–µ.
- –í —Å—Ç–µ–∫–µ –≤—ã–∑–æ–≤–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∏—á–µ–≥–æ, –∫—Ä–æ–º–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ `CALL`.

## –í—ã–±–æ—Ä–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

`SELECT ... INTO ...` –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫—É (–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ, —Ç–æ–≥–¥–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª–∑–æ–≤–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞) –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –∏ "—Ä–∞–∑–ª–æ–∂–∏—Ç—å" –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º:

```
DO $$
DECLARE
	r RECORD;
BEGIN
	SELECT id, name, address->>'country' INTO r FROM users WHERE id = 1;
	RAISE NOTICE '%', r;
END;
$$;
```

### –î—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã —Å –≤—ã–±–æ—Ä–∫–æ–π –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–ö–æ–º–∞–Ω–¥—ã `INSERT`, `UPDATE`, `DELETE` –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –ø–æ–º–æ—â—å—é —Ñ—Ä–∞–∑—ã `RETURNING`. –ò—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫–∂–µ, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –≤—ã—à–µ, –¥–æ–±–∞–≤–∏–≤ —Ñ—Ä–∞–∑—É `INTO`:

```
DO $$
DECLARE
	r RECORD;
BEGIN
	UPDATE table SET code = code || '!' WHERE id = 1 RETURNING * INTO r;
	RAISE NOTICE 'Updated row: %', r;
END;
DD;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞

- `INTO STRICT` ‚Äì –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–≤–Ω–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.
- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ `ROW_COUNT` ‚Äì —á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã—Ö (–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö) –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥–æ–π SQL. –ß—Ç–æ–±—ã –µ—ë –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–¥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ç—Ä–æ—á–∫—É –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ `GET DIAGNOSTICS rowcount = row_count;`.
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `FOUND` –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã SQL: –∏—Å—Ç–∏–Ω–∞, –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –≤–µ—Ä–Ω—É–ª–∞ (–æ–±—Ä–∞–±–æ—Ç–∞–ª–∞) —Å—Ç—Ä–æ–∫—É; –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞ ‚Äì –ø—Ä–∏–∑–Ω–∞–∫ —Ç–æ–≥–æ, —á—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—è. –ï—ë –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–æ–¥–µ: `RAISE NOTICE 'found = %', FOUND;`.

## –¢–∞–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- —Å—Ç—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É, –Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è.
- –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.
- —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è, –ø–æ–∫–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.

–ü—Ä–∏–º–µ—Ä —Ç–∞–±–ª–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:

```
-- LIKE t –∑–Ω–∞—á–∏—Ç —á—Ç–æ –≤–µ—Ä–Ω–µ—Ç –∫–∞–∫ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ t, —á—Ç–æ–±—ã –∑–∞–Ω–æ–≤–æ –Ω–µ –ø–∏—Å–∞—Ç—å
CREATE FUNCTION t() RETURNS TABLE(LIKE t)
AS $$
BEGIN
	RETURN QUERY SELECT id, code FROM t ORDER BY id;
END;
$$ STABLE LANGUAGE plpgsql;
```

–î—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äì –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ:

```
-- –§—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –æ—Ç –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –¥–æ –≤—Å, –Ω–∞ —è–∑—ã–∫–µ –ª–æ–∫–∞–ª–∏
-- –õ–æ–∫–∞–ª—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è: SET lc_time = 'en_US.UTF8'
CREATE FUNCTION days_of_week() RETURNS SETOF TEXT
AS $$
BEGIN
	FOR i IN 7 .. 13 LOOP
		RETURN NEXT to_char(to_date(i::text, 'J'), 'TMDy');
	END LOOP;
END;
-- STABLE –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ª–æ–∫–∞–ª–∏
$$ STABLE LANGUAGE plpgsql;
```

----
## –ö—É—Ä—Å–æ—Ä—ã

üîó [–ú–æ–¥—É–ª—å 13: –ö—É—Ä—Å–æ—Ä—ã](https://www.youtube.com/watch?v=7_wJ1Yn1TI4)

–û–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫—É—Ä—Å–æ—Ä–æ–º:
 - –≤—ã–±–æ—Ä–∫–∞ –ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
 - –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–µ –∫—É—Ä—Å–æ—Ä–∞
 - –æ–±—ã—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ü–∏–∫–ª–µ
 - –∑–∞–∫—Ä—ã—Ç–∏–µ

### –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ

–ö—É—Ä—Å–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –¥–ª—è –ª—é–±–æ–π –∫–æ–º–∞–Ω–¥—ã, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–µ–π —Å—Ç—Ä–æ–∫–∏.

```
-- –≤–∞—Ä–∏–∞–Ω—Ç 1
DO $$
DECLARE
	cur refcursor;
BEGIN
	-- —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞
	OPEN cur FOR SELECT * FROM users;
END;
$$;
```

```
-- –≤–∞—Ä–∏–∞–Ω—Ç 2
DO $$
DECLARE
	-- –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å –∑–∞–ø—Ä–æ—Å–æ–º
	cur CURSOR(id INTEGER) FOR SELECT * FROM users WHERE users.id = cur.id;
BEGIN
	-- –æ—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
	OPEN cur(1);
END;
$$;
```

### –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫—É—Ä—Å–æ—Ä–æ–º

–ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –∏–∑ –∫—É—Ä—Å–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π `FETCH`. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `MOVE`.

–ü—Ä–∏–º–µ—Ä—ã:

```
DO $$
DECLARE
	cur REFCURSOR;
	rec RECORD;
BEGIN
	OPEN cur FOR SELECT * FROM users ORDER BY id DESC;
	MOVE cur; -- –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
	FETCH cur INTO rec;
	RAISE NOTICE 'rec = %', rec;
	CLOSE cur;
END;
$$;
```

```
DO $$
DECLARE
	cur REFCURSOR;
	rec RECORD;
BEGIN
	OPEN cur FOR SELECT id, name, coffee_id FROM users ORDER BY id DESC;
	LOOP
		FETCH cur INTO rec;
		EXIT WHEN NOT FOUND; -- FOUND - –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ –æ—á–µ—Ä–µ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞?
		RAISE NOTICE 'rec = %', rec;
	END LOOP;
	CLOSE cur;
END;
$$;
```

```
DO $$
DECLARE
	cur CURSOR FOR SELECT id, name, coffee_id FROM users ORDER BY id DESC;
BEGIN
	FOR rec IN cur LOOP -- cur –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º!
		RAISE NOTICE 'rec = %', rec;
	END LOOP;
END;
$$;
```

–ö–æ–¥ –≤—ã—à–µ –º–æ–∂–Ω–æ –¥–∞–∂–µ –µ—â—ë —Å–æ–∫—Ä–∞—Ç–∏—Ç—å:

```
DO $$
DECLARE
	rec RECORD; -- –Ω–∞–¥–æ –æ–±—ä—è–≤–∏—Ç—å —è–≤–Ω–æ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ
BEGIN
	FOR rec IN (SELECT id, name, coffee_id FROM users ORDER BY id DESC) LOOP
		RAISE NOTICE 'rec = %', rec;
	END LOOP;
END;
$$;
```

### –ü–µ—Ä–µ–¥–∞—á–∞ –∫—É—Ä—Å–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç—É

```
DO $$
DECLARE
	cur REFCURSOR;
BEGIN
	OPEN cur FOR SELECT * FROM users ORDER BY id DESC;
	RAISE NOTICE 'cur = %', cur; -- –∏–º—è —Å–µ—Ä–≤–µ—Ä –≤—ã–¥–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
END;
$$;
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤–µ—Ä–Ω–µ—Ç –∫—É—Ä—Å–æ—Ä –∫–ª–∏–µ–Ω—Ç—É:

```
CREATE FUNCTION users_cur() RETURNS refcursor
AS $$
DECLARE
	cur REFCURSOR;
BEGIN
	OPEN cur FOR SELECT * FROM users ORDER BY id DESC;
	RETURN cur;
END;
$$ VOLATILE LANGUAGE plpgsql;
```

----
## –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã

üîó  https://www.youtube.com/watch?v=hXqvNW2pdcs

–¢–µ–∫—Å—Ç SQL-–∫–æ–º–∞–Ω–¥—ã —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

–ü—Ä–∏—á–∏–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
- –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≥–∏–±–∫–æ—Å—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏;
- —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ë–î;
- –≤–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç —Ä–∏—Å–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è (–∏–Ω—ä–µ–∫—Ü–∏–∏) SQL-–∫–æ–¥–∞;
- –≤–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è.

–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä `EXECUTE`.

```
DO $$
DECLARE
	cmd CONSTANT TEXT := 'CREATE TABLE IF NOT EXISTS city_msk(
		name TEXT,
		architect TEXT,
		built INTEGER
	)';
BEGIN
	EXECUTE cmd;
END;
$$;
```

–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ `INTO` –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ `EXECUTE` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –æ–¥–Ω—É (–ø–µ—Ä–≤—É—é) —Å—Ç—Ä–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ —Ç–∏–ø–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–∫–∞–ª—è—Ä–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `GET DIAGNOSTICS`, –∫–∞–∫ –∏ –≤ —Å–ª—É—á–∞–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ (–Ω–æ –Ω–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `FOUND`).

```
DO $$
DECLARE
	rec RECORD;
	cnt BIGINT;
BEGIN
	EXECUTE 'INSERT INTO city_msk (name, architect, built) VALUES
		(''–ü–∞—à–∫–æ–≤ –¥–æ–º'', ''–í–∞—Å–∏–ª–∏–π –ë–∞–∂–µ–Ω–æ–≤'', 1784),
		(''–ú—É–∑–µ–π –ü—É—à–∫–∏–Ω–∞'', ''–†–æ–º–∞–Ω –ö–ª–µ–π–Ω'', 1898),
		(''–¶–£–ú'', ''–†–æ–º–∞–Ω –ö–ª–µ–π–Ω'', 1908)
	RETURNING name, architect, built'
	INTO rec;
	RAISE NOTICE 'rec = %', rec;
	GET DIAGNOSTICS cnt = ROW_COUNT;
	RAISE NOTICE '–î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: %', cnt;
END;
$$;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ü–∏–∫–ª–µ `FOR`:

```
DO $$
DECLARE
	rec RECORD;
BEGIN
	FOR rec IN EXECUTE 'SELECT * FROM city_msk ORDER BY built'
	LOOP
		RAISE NOTICE 'rec = %', rec;
	END LOOP;
END;
$$;
```

----
## –ú–∞—Å—Å–∏–≤—ã

üîó 15. –ú–∞—Å—Å–∏–≤—ã https://www.youtube.com/watch?v=7iarp1dKnq8

–ú–∞—Å—Å–∏–≤—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –±–µ–∑ —è–≤–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–∫ *type-name[]*. –°–æ—Å—Ç–æ—è—Ç –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞. –ú–æ–∂–Ω–æ –±—Ä–∞—Ç—å —Å—Ä–µ–∑—ã –º–∞—Å—Å–∏–≤–∞; –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ö–æ–∂–¥–µ–Ω–∏—è, –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è, –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å ANY –∏ ALL –≤–º–µ—Å—Ç–æ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞, –∏ –¥—Ä.

```
DO $$
DECLARE
	arr INTEGER[]; -- –≤ —Å–∫–æ–±–∫–∞—Ö –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–¥–æ —É–∫–∞–∑—ã–≤–∞—Ç—å
BEGIN
	arr := ARRAY[10, 20, 30];
	RAISE NOTICE 'arr = %', arr;
	-- !!! –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —ç–ª–µ–º–µ–Ω—Ç—ã –Ω—É–º–µ—Ä—É—é—Ç—Å—è —Å –µ–¥–∏–Ω–∏—Ü—ã
	RAISE NOTICE '% % %', arr[1], arr[2], arr[3];
	-- —Å—Ä–µ–∑—ã –º–∞—Å—Å–∏–≤–∞
	RAISE NOTICE 'Slice [2:3] = %', arr[2:3];
END;
$$;
```

–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –º–∞—Å—Å–∏–≤, –ø–æ–ª—É—á–∏–≤ –µ–≥–æ –∏–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞:

```
DO $$
DECLARE
	arr INTEGER[]; -- –≤ —Å–∫–æ–±–∫–∞—Ö –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–¥–æ —É–∫–∞–∑—ã–≤–∞—Ç—å
BEGIN
	arr := ARRAY( SELECT n FROM generate_series(1,10) AS n );
	RAISE NOTICE 'arr = %', arr;
END;
$$;
```

–ú–æ–∂–Ω–æ –º–∞—Å—Å–∏–≤ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É —Ñ—É–Ω–∫—Ü–∏–µ–π `unnest()`:

```
SELECT unnest( ARRAY[1, 2, 3] );
```

–ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –º–Ω–æ–≥–æ–º–µ—Ä–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã.

### –ú–∞—Å—Å–∏–≤—ã –∏ —Ü–∏–∫–ª—ã

–ù–∞–ø–µ—á–∞—Ç–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –æ–¥–Ω–æ–º–µ—Ä–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞:

```
DO $$
DECLARE
	arr INTEGER[] := ARRAY[10, 20, 30, 40, 50];
BEGIN
	-- –¥–ª—è –æ–¥–Ω–æ–º–µ—Ä–Ω—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ –Ω–∏–∂–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 1:
	FOR i IN array_lower(arr, 1)..array_upper(arr, 1) LOOP
		RAISE NOTICE 'arr[%] = %', i, arr[i];
	END LOOP;
END;
$$;
```

–ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å—ã –Ω–µ –Ω—É–∂–Ω—ã, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã:

```
DO $$
DECLARE
	arr INTEGER[] := ARRAY[10, 20, 30, 40, 50];
	x INTEGER;
BEGIN
	FOREACH x IN ARRAY arr LOOP
		RAISE NOTICE 'x = %', x;
	END LOOP;
END;
$$;
```

–ò—Ç–µ—Ä–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –¥–≤—É–º–µ—Ä–Ω–æ–º –º–∞—Å—Å–∏–≤–µ:

```
DO $$
DECLARE
	arr INTEGER[] := ARRAY[
		ARRAY[ 1,  2,  3],
		ARRAY[10, 20, 30]
	];
BEGIN
	FOR i IN array_lower(arr, 1)..array_upper(arr, 1) LOOP -- –ø–æ —Å—Ç—Ä–æ–∫–∞–º
		FOR j IN array_lower(arr, 2)..array_upper(arr, 2) LOOP -- –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º
			RAISE NOTICE 'arr[%][%] = %', i, j, arr[i][j];
		END LOOP;
	END LOOP;
END;
$$;
```

–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ `VARIADIC` –≤ —è–∑—ã–∫–µ PL/pgSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—ä—è–≤–ª—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏, —Å–ø–æ—Å–æ–±–Ω—ã–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –∏ —ç—Ç–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∫ –º–∞—Å—Å–∏–≤. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `VARIADIC` –¥–µ–ª–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ–ª–µ–µ –≥–∏–±–∫–∏–º–∏ –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π —Ñ—É–Ω–∫—Ü–∏–∏. 

```
CREATE FUNCTION maximum(VARIADIC a INTEGER[]) RETURNS integer
AS $$
DECLARE
	x INTEGER;
	maxsofar INTEGER;
BEGIN
	FOREACH x IN ARRAY a LOOP
		IF x IS NOT NULL AND (maxsofar IS NULL OR x > maxsofar) THEN
			maxsofar := x;
		END IF;
	END LOOP;
	RETURN maxsofar;
END;
$$ IMMUTABLE LANGUAGE plpgsql;
```

–ü—Ä–æ–±—É–µ–º: `SELECT maximum(12, 65, 47);`.

–î–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª–∏–º–æ—Ä—Ñ–Ω–æ–π.

–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è¬†`%TYPE`¬†–≤¬†PL/pgSQL¬†–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è¬†–¥–ª—è¬†–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è¬†—Ç–∏–ø–∞¬†–¥–∞–Ω–Ω—ã—Ö¬†–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π¬†–Ω–∞¬†–æ—Å–Ω–æ–≤–µ¬†—Ç–∏–ø–∞¬†–¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–∞¬†—Ç–∞–±–ª–∏—Ü—ã¬†–∏–ª–∏¬†–¥—Ä—É–≥–æ–≥–æ¬†–æ–±—ä–µ–∫—Ç–∞¬†–±–∞–∑—ã¬†–¥–∞–Ω–Ω—ã—Ö.

```
CREATE FUNCTION poly_maximum(VARIADIC a ANYARRAY, maxsofar OUT ANYELEMENT)
AS $$
DECLARE
	-- PL/pgSQL –ø—Ä–æ anyarray/anyelement –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç. –ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
	-- —Ç–µ–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç—É–¥–∞ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
	-- —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç: x –±—É–¥–µ—Ç –∏–º–µ—Ç—å —Ç–∞–∫–æ–π –∂–µ —Ç–∏–ø, –∫–∞–∫ maxsofar
	x maxsofar%TYPE;
BEGIN
	FOREACH x IN ARRAY a LOOP
		IF x IS NOT NULL AND (maxsofar IS NULL OR x > maxsofar) THEN
			maxsofar := x;
		END IF;
	END LOOP;
END;
$$ IMMUTABLE LANGUAGE plpgsql;
```

–ü—Ä–æ–±—É–µ–º: `SELECT maximum(12, 65, 47); SELECT poly_maximum(12.1, 65.2, 47.3);`.

----
## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

üîó –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ https://www.youtube.com/watch?v=dpY9xkC8P-k

–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–µ–∫—Ü–∏—è `EXCEPTION`.

```
DECLARE
	...
BEGIN
	...
	-- —á—Ç–æ-—Ç–æ –¥–µ–ª–∞–µ–º...
EXCEPTION
	WHEN no_data_found THEN
		RAISE NOTICE '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
	WHEN too_many_rows THEN
		...
END;
```

–í PL/pgSQL –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –±–ª–æ–∫–µ `EXCEPTION` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∞–º –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–µ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞. –°–∏–Ω—Ç–∞–∫—Å–∏—Å —Å–µ–∫—Ü–∏–∏ `EXCEPTION` –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```
BEGIN
 -- –û–ø–µ—Ä–∞—Ç–æ—Ä—ã
 EXCEPTION WHEN —É—Å–ª–æ–≤–∏–µ THEN
 -- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
END;
```

–£—Å–ª–æ–≤–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–º–µ–Ω–µ–º –æ—à–∏–±–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä `division_by_zero`, –∏–ª–∏ –∫–æ–¥–æ–º `SQLSTATE`, –Ω–∞–ø—Ä–∏–º–µ—Ä `22012`. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∏ –æ–¥–Ω–æ–º—É –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π, –æ–Ω–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –Ω–∞—Ä—É–∂—É. –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –æ—à–∏–±–æ–∫ –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, —Ç–∞–∫–∏–µ –∫–∞–∫ –≤—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ö–æ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–ª–∏ –¥–∞–∂–µ –ø–æ–≤—Ç–æ—Ä –ø–æ–ø—ã—Ç–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏. –í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –≤–Ω–µ—Å–µ–Ω–Ω—ã–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–æ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –æ—à–∏–±–∫–∏, –±—É–¥—É—Ç –æ—Ç–º–µ–Ω–µ–Ω—ã, –Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –≤–Ω–µ—Å–µ–Ω–Ω—ã–µ –¥–æ –Ω–∞—á–∞–ª–∞ –±–ª–æ–∫–∞, –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏. –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ `division_by_zero`:

```
BEGIN
	INSERT INTO mytab(firstname, lastname) VALUES('Tom', 'Jones');
	UPDATE mytab SET firstname = 'Joe' WHERE lastname = 'Jones';
	x:= x + 1;
	y:= x / 0;
	EXCEPTION WHEN division_by_zero THEN
		RAISE NOTICE '–ü–µ—Ä–µ—Ö–≤–∞—Ç–∏–ª–∏ –æ—à–∏–±–∫—É division_by_zero';
		 RETURN x;
END;
```

–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ, –µ—Å–ª–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ `y := x / 0` –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –æ—à–∏–±–∫–∞ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å, –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ x, —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É.    

–¢–æ–Ω–∫–∏–π –º–æ–º–µ–Ω—Ç: –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –≤ —Å–µ–∫—Ü–∏–∏ `DECLARE`, –∏–ª–∏ –≤ —Å–∞–º–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ `EXCEPTION`, —Ç–æ –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ –µ—ë –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.

–í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —É–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–¥ –æ—à–∏–±–∫–∏. –ù–∞–ø—Ä–∏–º–µ—Ä:

```
...
EXCEPTION
	WHEN SQLSTATE 'P0003' OR no_data_found THEN -- –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ
		...
END;
```

----
## –¢—Ä–∏–≥–≥–µ—Ä—ã

üîó –¢—Ä–∏–≥–≥–µ—Ä—ã https://www.youtube.com/watch?v=F3jQRbsDXVE

**–¢—Ä–∏–≥–≥–µ—Ä**: –æ–±—ä–µ–∫—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ‚Äì —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö —Å–æ–±—ã—Ç–∏–π; –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏ –µ–π –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç.

**–¢—Ä–∏–≥–≥–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: –æ–±—ä–µ–∫—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ‚Äì –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è; –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —á—Ç–æ –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è. –°–æ–≥–ª–∞—à–µ–Ω–∏–µ: —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Å–µ–≤–¥–æ—Ç–∏–ø–∞ `trigger` (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ `record`). –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö.

–° –ø–æ–º–æ—â—å—é —Ç—Ä–∏–≥–≥–µ—Ä–∞ –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é, –∏–∑–º–µ–Ω–∏—Ç—å –µ—ë —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è. –¢—Ä–∏–≥–≥–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∫ —á–∞—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –æ—à–∏–±–∫–∞ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—Ç–∫–∞—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

–°–æ–±—ã—Ç–∏—è: `INSERT`, `UPDATE`, `DELETE`, `TRUNCATE`, —É—Å–ª–æ–≤–∏–µ `WHEN` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä.

**Before Statement**:
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: –¥–æ –æ–ø–µ—Ä–∞—Ü–∏–∏.
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: TG-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.

**Before Row** (—Ç–∞–±–ª–∏—Ü–∞) / **Instead of Row** (–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è):
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º —Å–æ —Å—Ç—Ä–æ–∫–æ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: —Å—Ç—Ä–æ–∫–∞ (–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–Ω–∞—è) –∏–ª–∏ `NULL` (–æ—Ç–º–µ–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –¥–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏).
- –ö–æ–Ω—Ç–µ–∫—Å—Ç:
	- `OLD` (update, delete)
	- `NEW` (insert, update)
	- TG-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.

**After Row**
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏; –æ—á–µ—Ä–µ–¥—å –∏–∑ –ø—Ä–æ—à–µ–¥—à–∏—Ö —É—Å–ª–æ–≤–∏–µ `WHEN`.
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.
- –ö–æ–Ω—Ç–µ–∫—Å—Ç:
	- `OLD`, `OLD TABLE` ‚Äì update, delete
	- `NEW`, `NEW TABLE` ‚Äì insert, update
	- TG-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

**After Statement**
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç–∞ –Ω–∏ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞).
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.
- –ö–æ–Ω—Ç–µ–∫—Å—Ç:
	- `OLD TABLE` ‚Äì update, delete
	- `NEW TABLE` ‚Äì insert, update
	- TG-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

### –ü–æ—Ä—è–¥–æ–∫ –≤—ã–∑–æ–≤–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

–°–æ–∑–¥–∞–¥–∏–º "—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é" —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–∞ –≤—ã–∑–≤–∞–Ω–∞. –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö `TG_...`-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

```
CREATE FUNCTION describe_tg() RETURNS TRIGGER
AS $$
DECLARE 
	rec RECORD;
	str TEXT := '';
BEGIN
	IF TG_LEVEL = 'ROW' THEN
		CASE TG_OP
			WHEN 'DELETE' THEN rec := OLD; str := OLD::text;
			WHEN 'UPDATE' THEN rec := NEW; str := OLD || ' -> ' || NEW;
			WHEN 'INSERT' THEN rec := NEW; str := NEW::text;
		END CASE;
	END IF;

	RAISE NOTICE '% % % %: %', TG_TABLE_NAME, TG_WHEN, TG_OP, TG_LEVEL, str;
	return rec;
END;
$$ LANGUAGE plpgsql;
```

–£—Å—Ç–∞–Ω–æ–≤–∏–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è:

```
CREATE TRIGGER t_before_stmt
BEFORE INSERT OR UPDATE OR DELETE 	-- —Å–æ–±—ã—Ç–∏—è
ON users							-- —Ç–∞–±–ª–∏—Ü–∞
FOR EACH STATEMENT					-- —É—Ä–æ–≤–µ–Ω—å
EXECUTE FUNCTION describe_tg();		-- —Ç—Ä–∏–≥–≥–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞
```

–£—Å—Ç–∞–Ω–æ–≤–∏–≤ —á–µ—Ç—ã—Ä–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –Ω–∞ BEFORE/AFTER STATEMENT, ROW –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —É–≤–∏–¥–∏–º –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–µ:

```
NOTICE: users BEFORE INSERT STATEMENT: 
NOTICE: users BEFORE INSERT ROW: (11,Alex,,,f,,) 
NOTICE: users AFTER INSERT ROW: (11,Alex,,,f,,) 
NOTICE: users AFTER INSERT STATEMENT: 
INSERT 0 1
```

### –ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

–ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã `old_table` –∏ `new_table` "–≤—ã–≥–ª—è–¥—è—Ç" –Ω–∞—Å—Ç–æ—è—â–∏–º–∏, –Ω–æ –Ω–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ –∏ —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏.

> [!info] 
> –ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–µ–π.

–ù–∞–ø–∏—à–µ–º —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü.

```
CREATE OR REPLACE FUNCTION transition_tg() RETURNS TRIGGER
AS $$
DECLARE 
	rec RECORD;
BEGIN
	IF TG_OP = 'DELETE' OR TG_OP = 'UPDATE' THEN
		RAISE NOTICE '–°—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:';
		FOR rec IN SELECT * FROM old_table LOOP
			RAISE NOTICE '%', rec;
		END LOOP;
	END IF;

	IF TG_OP = 'UPDATE' OR TG_OP = 'INSERT' THEN
		RAISE NOTICE '–ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:';
		FOR rec IN SELECT * FROM new_table LOOP
			RAISE NOTICE '%', rec;
		END LOOP;
	END IF;

	RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

–¢–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–æ–≤–∏–º —ç—Ç–æ—Ç —Ç—Ä–∏–≥–≥–µ—Ä —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏–º—ë–Ω —Ç–∞–±–ª–∏—Ü:

```
CREATE TRIGGER t_after_upd_trans
AFTER UPDATE ON users
REFERENCING
	OLD TABLE AS old_table
	NEW TABLE AS new_table
FOR EACH STATEMENT
EXECUTE FUNCTION transition_tg();
```

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏, –≤—ã–≤–µ–¥–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–µ:

```
NOTICE: –°—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: 
NOTICE: (11,Alex,,,f,,) 
NOTICE: –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: 
NOTICE: (11,Alex,,,f,Gold,) 
UPDATE 1
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

- –°–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –Ω–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö –ø–æ—á—Ç–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å: –∫–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ—è–≤–Ω–æ, —Ç—Ä—É–¥–Ω–æ –ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –∫—Ä–∞–π–Ω–µ —É—Å–ª–æ–∂–Ω—è–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –ù–µ–ª—å–∑—è –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è, —Ç.–∫. –æ–Ω–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, –∏ –Ω–∞–ø—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –º–æ–∂–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –∏–∑–º–µ–Ω–∏—Ç—å.

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

#### –ü—Ä–∏–º–µ—Ä 1: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫

–ü–æ–¥–¥–µ—Ä–∂–∫—É "–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π" —Ç–∞–±–ª–∏—Ü—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –≤–æ–∑–ª–æ–∂–∏—Ç—å –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î —ç—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ. [–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –≤ –≤–∏–¥–µ–æ](https://youtu.be/F3jQRbsDXVE?si=t5wD0NVKe5ObXyDN&t=2078).

#### –ü—Ä–∏–º–µ—Ä 2: –æ–±–Ω–æ–≤–ª—è–µ–º–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

[–í–∏–¥–µ–æ](https://youtu.be/F3jQRbsDXVE?si=dOKqW3fEjDdbhsyB&t=2563)

### –°–æ–±—ã—Ç–∏–π–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

–ü–æ—Ö–æ–∂–∏ –Ω–∞ –æ–±—ã—á–Ω—ã–µ "—Ç–∞–±–ª–∏—á–Ω—ã–µ" —Ç—Ä–∏–≥–≥–µ—Ä—ã, –Ω–æ –¥—Ä—É–≥–æ–π –æ–±—ä–µ–∫—Ç. –°—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –Ω–∞ DDL-–æ–ø–µ—Ä–∞—Ü–∏–∏: `CREATE`, `ALTER`, `DROP`, etc. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±–æ–ª—å—à–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, —á–µ–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.

–¢—Ä–∏–≥–≥–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç  –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Å–µ–≤–¥–æ—Ç–∏–ø–∞ `event_trigger`. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–ª—É–∂–∞—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.

–°–æ–±—ã—Ç–∏—è:
- `DDL_COMMAND_START` ‚Äì –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–æ–º–∞–Ω–¥—ã
- `DDL_COMMAND_END` ‚Äì –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
- `TABLE_REWRITE` ‚Äì –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é —Ç–∞–±–ª–∏—Ü—ã
- `SQL_DROP` ‚Äì –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤

----
## –û—Ç–ª–∞–¥–∫–∞

üîó [–í–∏–¥–µ–æ](https://www.youtube.com/watch?v=zoHn5zOiKio)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

–û–ø–µ—Ä–∞—Ç–æ—Ä `ASSERT` —Å –¥–≤—É–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: –ø–µ—Ä–≤—ã–π ‚Äì –ª–æ–≥–∏—á–µ—Å–∫–∏–π, –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ç–∏–Ω—É, –µ—Å–ª–∏ –≤—Å—ë —Ö–æ—Ä–æ—à–æ; –≤—Ç–æ—Ä–æ–π ‚Äì —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, `ASSERT X > 0, '–• –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è';`.

### Debugger

–ï—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pldbgapi`. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –µ–≥–æ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ pgAdmin.

### –°–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–≠—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç–ª–∞–¥–∫–∞ –∫–æ–¥–∞: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ–ª–≥–æ –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤; –≤–µ–¥–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–ü–æ–¥—Ö–æ–¥—ã –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- –≤—ã–≤–æ–¥ –Ω–∞ –∫–æ–Ω—Å–æ–ª—å –∏–ª–∏ –≤ –∂—É—Ä–Ω–∞–ª —Å–µ—Ä–≤–µ—Ä–∞;
- –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –≤ —Ñ–∞–π–ª;
- –ø–µ—Ä–µ–¥–∞—á–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º.

–ö–æ–º–∞–Ω–¥–∞ `RAISE` –∏–º–µ–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `DEBUG`, `LOG`, `NOTICE`, `INFO`, `WARNING`.

### –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É: —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `dblink`

–£—Å—Ç–∞–Ω–æ–≤–∏–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–µ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):

```
CREATE EXTENSION dblink;
```

–°–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:

```
CREATE TABLE log (
	id 			INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
	username	TEXT,
	ts			TIMESTAMPTZ,
	message		TEXT
);
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É `log`. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Å–µ–∞–Ω—Å, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å—Ç–∞–≤–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–µ–∞–Ω—Å.

```
CREATE PROCEDURE write_log(message TEXT)
AS $$
DECLARE 
	cmd TEXT;
BEGIN
	cmd := format(
		'INSERT INTO log(username, ts, message)
		VALUES (%L, %L::timestamptz, %L)',
		user, clock_timestamp()::text, write_log.message
	);
	PERFORM dblink('dbname=' || current_database(), cmd);
END;
$$ LANGUAGE plpgsql;
```

### –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª: —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `adminpack`

–≠—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –µ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —É—Å—Ç–∞–Ω–æ–≤–∏–º –µ–≥–æ:

```
CREATE EXTENSION adminpack;
```

–°–∞–º–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª:

```
CREATE PROCEDURE write_file(message TEXT)
AS $$
DECLARE
	filename CONSTANT text := '/var/lib/postgresql/data/log/user_log.txt';
	message TEXT;
BEGIN
	message := format(
		E'%s, %s, %s\n',
		session_user, clock_timestamp()::text, write_file.message
	);
	PERFORM pg_file_write(filename, message, /*append*/ true);
END;
$$ LANGUAGE plpgsql;
```

https://youtu.be/zoHn5zOiKio?si=0dIH7qu5YneKSbXd&t=2435 –∑–∞–∫–æ–Ω—á–∏–ª —Å–º–æ—Ç—Ä–µ—Ç—å 12 –º–∞—è 2024 –≥.